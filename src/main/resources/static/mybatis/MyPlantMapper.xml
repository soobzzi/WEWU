<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
		
<mapper namespace = "life.wewu.web.service.plant.PlantDao">
	
	<resultMap id="myPlantSelectMap" type="life.wewu.web.domain.plant.MyPlant" >
		<result property="myPlantNo" 		column="my_plant_no" 		jdbcType="INTEGER"/>
		<result property="myPlantState"		column="my_plant_state" 	jdbcType="VARCHAR" />
		<result property="myPlantName" 		column="my_plant_name" 		jdbcType="VARCHAR" />
		<result property="myPlantExp" 		column="my_plant_exp" 		jdbcType="INTEGER" />
		<result property="plantStartDate" 	column="plant_start_date" 	jdbcType="DATE" />
		<result property="plantEndDate"		column="plant_end_date"		jdbcType="DATE"/>
		<result property="weatherNo"		column="weather_no"			jdbcType="INTEGER"/>
		<result property="weatherImg"		column="weather_img"		jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- GET RANDOM MYPLANT -->
	<select id="selectRandomPlant" parameterType="life.wewu.web.domain.plant.MyPlant">
		SELECT le.levl_img, p.plant_no
		FROM plant_levl le, plant p
		WHERE p.plant_no IN ( SELECT le2.plant_no
				FROM plant_levl le2
				WHERE le2.plant_levl = '새싹')
		ORDER BY RAND()
		limit 1
	</select>
	
	<insert id="addRandomPlant" parameterType="life.wewu.web.domain.plant.MyPlant">
		INSERT INTO my_plant (myPlant_no,my_plant_state,my_plant_name,my_plant_exp,plant_start_date)
		VALUE (AUTO_INCREMENT,'Y',#{myPlantName},0,CURRENT_TIMESTAMP)
	</insert>
	
	<!-- GET MYPLANTliST -->
	<select id="getMyPlantList" parameterType = "life.wewu.web.common.Search" >
		SELECT 
			m.my_plant_no, m.my_plant_state , m.plant_start_date, m.plant_end_date , le.plant_levl , le.levl_Img , m.nickname, le.plant_max_exp,le.plant_min_exp
    	FROM 
    		my_plant m , plant_levl le
  	 	WHERE m.plant_no = le.plant_no
  	 	AND m.nickname = #{nickname}
   		AND #{myPlantExp} between #{plant_min_exp} and #{plant_max_exp};
   		
			<if test = "my_plant_state != null and my_plant_state == 'Y'">
				AND m.my_plant_state = 'Y'	
			</if>
				
			<if test = "my_plant_state != null and my_plant_state == 'N'">
				AND m.my_plant_state = 'N'
			</if>
	</select>
	
	<update id="updateMyPlant" parameterType="int">
		UPDATE my_plant
	   	<set>
	   		my_plant_name = #{myPlantName} 
	   	</set>
	   	WHERE my_Plant_no = #{myPlantNo}
	 </update>
	 
	 <update id="deleteMyPlant" parameterType="int">
	 	UPDATE my_plant
	 	<set>	
	 		my_plant_state = 'N'
	 	</set>
	 	WHERE my_plant_no = #{myPlantNo}
	 </update>
	
	
	<update id="useItemAndExpIncrease"  parameterType="int">
		UPDATE item_purchase
		<set>
			item_stock = item_stock - 1
		</set>
			WHERE item_purchase_no = #{itemPurchaseNo} AND item_stock > 0;
		
		UPDATE my_plant
        <set>
        	my_plant_exp = my_plant_exp + (SELECT item_effect FROM item WHERE item_no = #{itemNo})
        </set> 
        WHERE my_plant_no = #{myPlantNo};
	</update>
	
	
	
	
	
	
</mapper>